name: CoolBeans Grafana CI/CD Pipeline

on:
  push:
    paths:
      - 'database/docker/grafana/**'
      - '.github/workflows/grafana.yml'

jobs:
  validate-grafana:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Start services
        run: |
          cd database/docker
          docker compose up -d
        env:
          POSTGRES_DB: ${{ vars.POSTGRES_DB }}
          POSTGRES_USER: ${{ vars.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT: ${{ vars.POSTGRES_PORT }}
          GRAFANA_USER: ${{ vars.GRAFANA_USER }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          GRAFANA_PORT: ${{ vars.GRAFANA_PORT }}
      
      - name: Wait for services to be ready
        run: |
          sleep 10
          cd database/docker
          docker compose logs

      - name: Verify TimescaleDB connection
        run: |
          cd database/docker
          docker compose exec -T timescaledb \
            psql -U ${{ vars.POSTGRES_USER }} \
                 -d ${{ vars.POSTGRES_DB }} \
                 -c "SELECT * FROM pg_extension WHERE extname='timescaledb';"

      - name: Verify Grafana is running
        run: |
          cd database/docker
          curl -sf http://localhost:${GRAFANA_PORT}/api/health
        env:
          GRAFANA_PORT: ${{ vars.GRAFANA_PORT }}

      - name: Stop services
        run: |
          cd database/docker
          docker compose down

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push custom Grafana image
        run: |
          docker build -t coolbeans_grafana ./database/docker/grafana
          docker tag coolbeans_grafana:latest ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_grafana:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_grafana:latest
        
      - name: Build and push TimescaleDB image
        run: |
          cd database/docker/timescaledb
          docker build -t coolbeans_timescaledb:latest .
          docker tag coolbeans_timescaledb:latest ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_timescaledb:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_timescaledb:latest

  deploy-grafana:
    needs: validate-grafana
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v5

      - name: Stop existing Grafana container
        run: |
          sudo docker stop coolbeans_grafana:latest || true
          sudo docker rm coolbeans_grafana:latest || true

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Pull updated Grafana image
        run: |
          sudo docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_grafana:latest
          sudo docker tag ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_grafana:latest coolbeans_grafana:latest

      - name: Deploy updated Grafana image
        run: |
          sudo docker run -d --name coolbeans_grafana -p 3001:3001 -v grafana_data:/var/lib/grafana -e GF_SECURITY_ADMIN_PASSWORD=$GRAFANA_PASSWORD coolbeans_grafana:latest
        env:
          POSTGRES_DB: ${{ vars.POSTGRES_DB }}
          POSTGRES_USER: ${{ vars.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT: ${{ vars.POSTGRES_PORT }}
          GRAFANA_USER: ${{ vars.GRAFANA_USER }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          GRAFANA_PORT: ${{ vars.GRAFANA_PORT }}

      - name: Stop existing TimescaleDB container
        run: |
          sudo docker stop coolbeans_timescaledb:latest || true
          sudo docker rm coolbeans_timescaledb:latest || true

      - name: Pull updated TimescaleDB image
        run: |
          sudo docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_timescaledb:latest
          sudo docker tag ${{ secrets.DOCKER_HUB_USERNAME }}/coolbeans_timescaledb:latest coolbeans_timescaledb:latest

      - name: Deploy updated TimescaleDB image
        run: |
          sudo docker run -d --name coolbeans_timescaledb \
            -p 5432:5432 \
            -v timescale_data:/var/lib/postgresql/data \
            -e POSTGRES_DB=${{ vars.POSTGRES_DB }} \
            -e POSTGRES_USER=${{ vars.POSTGRES_USER }} \
            -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
            coolbeans_timescaledb:latest
        env:
          POSTGRES_DB: ${{ vars.POSTGRES_DB }}
          POSTGRES_USER: ${{ vars.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT: ${{ vars.POSTGRES_PORT }}

