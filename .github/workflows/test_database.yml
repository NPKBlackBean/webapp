name: Test TimescaleDB Setup

on:
  pull_request:
    paths:
      - "database/**"
  push:
    branches:
      - main
    paths:
      - "database/**"

jobs:

  test-db:
    runs-on: ubuntu-latest
    
    steps:
       - name: Checkout repository
         uses: actions/checkout@v4
         
       - name: Set up Docker
         uses: docker/setup-buildx-action@v3
       
       - name: Start TimescaleDB with Docker Compose
         working-directory: database/docker
         run: docker compose up -d
          
       - name: Wait for database to be ready
         run: |
          for i in $(seq 1 20); do
           if docker exec timescaledb pg_isready -U admin; then
                  echo "Database is ready"
                  exit 0
           fi
            
           echo "Waiting for database..."
           sleep 3
          done
          
          echo "Database not ready in time"
          exit 1
          
       - name: Verify TimescaleDB extension
         run: docker exec timescaledb psql -U admin -d metrics -c "\dx" | grep timescaledb
    
       - name: Verify soil_chemistry table exists
         run: docker exec timescaledb psql -U admin -d metrics -c "\dt" | grep soil_chemistry
    
       - name: Shut down containers
         if: always() 
         working-directory: database/docker
         run: docker compose down
