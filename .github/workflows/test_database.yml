name: Test TimescaleDB Setup

on:
  pull_request:
    paths:
      - "database/**"
  push:
    branches:
      - main
    paths:
      - "database/**"

jobs:

  test-db:
    runs-on: ubuntu-latest
    
    steps:
       - name: Checkout repository
         uses: actions/checkout@v4
         
       - name: Set up Docker
         uses: docker/setup-buildx-action@v3
       
       - name: Start TimescaleDB with Docker Compose
         working-directory: database/docker
         run: docker compose up -d
          
       - name: Verify TimescaleDB extension
         run: docker exec timescaledb psql -U admin -d metrics -c "\dx" | grep timescaledb
    
       - name: Verify soil_chemistry table exists
         run: docker exec timescaledb psql -U admin -d metrics -c "\dt" | grep soil_chemistry
    
       - name: Shut down containers
         if: always() 
         working-directory: database/docker
         run: docker compose down
